clc
clear all
close all 

globals;

%% New implementation without staggered grid %%
N = 20; 
P = 20;
Q = 20; 

X = (0:N)/N; Y = 0:P]/P; T = [0:Q]/Q;
[XX,YY] = meshgrid(X,Y); %YY = flipud(YY);

normalise = @(f) f/sum(f(:)); epsilon = 0.05;
f0 = normalise(epsilon + gauss(0.2,0.3,0.1,N,P));
f1 = normalise(epsilon + gauss(0.6,0.7,0.7,N,P) + 0.6*gauss(0.7,0.4,0.7,N,P));

contour(XX,YY,f0); hold on; contour(XX,YY,f1)
return
J = @(w) sum(sum(sum((w(:,:,:,1).^2 + w(:,:,:,2).^2)./max(w(:,:,:,3),max(epsilon,1e-10))))); % cost 

alpha = 1.0; % must be in ]0,2[
beta  = 1; % must be ine [0,1]
gamma = 0.5; % must be > 0

z  = zeros(P+1,N+1,Q,3);
w0 = zeros(P+1,N+1,Q,3); w1 = zeros(P+1,N+1,Q,3);

niter = 500;
cout = zeros(1,niter);
minF = zeros(1,niter);
divV = zeros(1,niter);

tic
for l = 1:niter
    w1 = w0 + alpha*(proxJ(2*z-w0,gamma) - z);
    [z, divV(l)] = projC(w1);
    w0 = w1;
    if mod(l,10) == -1
        contour(XX,YY,z(:,:,floor(Q/2)))
        title(['Iteration ',num2str(l)]);
        drawnow;
    end
    
    cout(l) = J(z);
    minF(l) = min(min(z(:,:,2)));
end
toc
close all
I = floor(Q/6);
figure; 
subplot(2,3,1), 
contour(XX,YY,z(:,:,1,3));
title('initial density - t=0');

subplot(2,3,2),
contour(XX,YY,z(:,:,I,3));
title(['density at t = ',num2str(T(I))]);

subplot(2,3,3),
contour(XX,YY,z(:,:,2*I,3));
title(['density at t = ',num2str(T(2*I))]);

subplot(2,3,4),
contour(XX,YY,z(:,:,3*I,3));
title(['density at t = ',num2str(T(3*I))]);

subplot(2,3,5),
contour(XX,YY,z(:,:,4*I,3));
title(['density at t = ',num2str(T(4*I))]);

subplot(2,3,6), 
contour(XX,YY,z(:,:,end,3));
title('Target density - t=1');

figure; 
subplot(311)
plot([1:niter],cout);
title('cout');
subplot(312)
plot([1:niter],minF);
title('Minimum de F');
subplot(313);
plot([1:niter],divV);
title('divergence violation');

